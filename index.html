<!DOCTYPE html>
<html lang="kn">
<head>
  <meta charset="UTF-8" />
  <title>ಪೂಜೆ ಸೇವಾದಾರರು</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: "Noto Sans Kannada", sans-serif;
      padding: 20px;
      background-color: #f9f9f9;
    }
    button {
      font-size: 16px;
      margin: 10px;
      padding: 10px 20px;
      border: none;
      background-color: #5a189a;
      color: white;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover {
      background-color: #7b2cbf;
    }
    #output {
      margin-top: 20px;
    }
    .person {
      background: white;
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <h2>ಪೂಜೆ ಸೇವಾದಾರರು</h2>
  <input type="file" id="fileInput" accept=".xlsx" />
  <br/>
  <button onclick="showToday()">ಇಂದು ಪೂಜೆಗೆ</button>
  <button onclick="showAll()">ಈ ತಿಂಗಳ ಸೇವಾದಾರರು</button>

  <div id="output"></div>

  <script>
    let allData = [];

    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const reader = new FileReader();

      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, {header: 1, defval: ""});

        allData = [];

        for (let row of rows) {
          const name = row[3]?.toString().trim();        // column D
          const dateStr = row[8]?.toString().trim();     // column I
          const month = row[1]?.toString().trim();       // column B
          let rashi = row[10]?.toString().trim();        // column L
          let nakshatra = row[4]?.toString().trim();     // column E
          let gotra = row[5]?.toString().trim();         // column F (sometimes all 3 in one)

          // If all details are in one cell (F), split them
          if (gotra && gotra.includes('\n')) {
            const parts = gotra.split('\n').map(p => p.trim()).filter(Boolean);
            [gotra, nakshatra, rashi] = parts;
          }

          if (name && dateStr) {
            const [day, monthNum, year] = dateStr.split(/[-/]/).map(Number);
            if (!isNaN(day) && !isNaN(monthNum) && !isNaN(year)) {
              const date = new Date(year, monthNum - 1, day);
              allData.push({ name, gotra, nakshatra, rashi, date, month });
            }
          }
        }

        alert("ದಾಖಲೆಗಳನ್ನು ಯಶಸ್ವಿಯಾಗಿ ಓದಲಾಗಿದೆ!");
      };

      reader.readAsArrayBuffer(file);
    });

    function showToday() {
      const today = new Date();
      const list = allData.filter(p =>
        p.date.getDate() === today.getDate() &&
        p.date.getMonth() === today.getMonth() &&
        p.date.getFullYear() === today.getFullYear()
      );
      display(list, "ಇಂದಿನ");
    }

    function showAll() {
      const month = new Date().getMonth();
      const list = allData.filter(p => p.date.getMonth() === month);
      display(list, "ಈ ತಿಂಗಳ");
    }

    function display(list, title) {
      const out = document.getElementById("output");
      if (list.length === 0) {
        out.innerHTML = `<p>${title} ಸೇವಾದಾರರು ಲಭ್ಯವಿಲ್ಲ.</p>`;
        return;
      }
      out.innerHTML = `<h3>${title} ಸೇವಾದಾರರು:</h3>` +
        list.map(p => `
          <div class="person">
            <strong>ಹೆಸರು:</strong> ${p.name}<br>
            <strong>ಗೋತ್ರ:</strong> ${p.gotra || '-'}<br>
            <strong>ನಕ್ಷತ್ರ:</strong> ${p.nakshatra || '-'}<br>
            <strong>ರಾಶಿ:</strong> ${p.rashi || '-'}<br>
            <strong>ದಿನಾಂಕ:</strong> ${p.date.toLocaleDateString('kn-IN')}<br>
            <strong>ತಿಂಗಳು:</strong> ${p.month || '-'}
          </div>
        `).join('');
    }
  </script>
</body>
</html>
